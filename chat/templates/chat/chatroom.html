{% extends 'layout.html' %}


{% block content %}
    <div class="container mt-5">
        <div class="row d-flex justify-content-center">
            <div class="col-6">
                <div class="h4">Chatroom dla {{ organization }}</div>
                <div class="form-control chat-window">
                    <ul id="message-list">
                        {% for message in messages %}
                            <li>{{ message.sender }}: {{ message.content }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <input class="form-control" id="input" type="text"></br>
                <input class="btn btn-secondary btn-lg btn-block" id="submit" type="button" value="Send">
            </div>
            <div class="col-6">
                <ul>
                    {% for member in members %}
                        <li {% if member.is_admin %}style='color:red'{% endif %}>{{ member.creator }} - {{ member.get_role_display }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>


    {{ team_id|json_script:"team-id" }}
    {{ request.user.email|json_script:"user-username" }}
    <script>
        function appendNewMsg(rawData) {
            const messageList = document.querySelector('#message-list');
            const data = JSON.parse(rawData);
            const newMsg = `<li>${data.username}: ${data.message}</li>`;

            messageList.innerHTML += newMsg;

        }

        function sendMsg(event){
            const messageInputDom = document.querySelector('#input');
            const message = messageInputDom.value;
            // Send to websocket
            socket.send(JSON.stringify({
                'message': message,
                'username': JSON.parse(document.getElementById('user-username').textContent)
            }));
            messageInputDom.value = '';
        }

        function configureWebSocket(){
            // Configure new WebSocket
            const loc = window.location;
            let wsStart = (loc.protocol === 'https:') ? 'wss://' : 'ws://'
            const endpoint = wsStart + loc.host + loc.pathname + '/'

            const socket = new WebSocket(endpoint);

            // Configure events
            // Receive from websocket
            socket.onmessage = function (e) {
                console.log('message', e)
                appendNewMsg(e.data);
            }

            socket.onopen = function (e) {
                console.log('open', e)
                //#TODO make user icon online when connection opened
            }
            socket.onclose = function (e) {
                console.log('close', e)
                //#TODO make user icon offline when connection closed
            }
            socket.onerror = function (e) {
                console.log('error', e)
            }

            return socket

        }

        const socket = configureWebSocket();
        document.querySelector('#submit').onclick = sendMsg;
        


        
    </script>
{% endblock content %}
